// IW8 GSC SOURCE
// Generated by https://github.com/xensik/gsc-tool

get_recent_spawn_time_threshold()
{
    if ( !isdefined( level._id_128BB ) )
        level._id_128BB = [];

    level._id_128BB["sniper"] = ::_id_120F5;
}

_id_120F5()
{
    blockreviveanimation();

    if ( !isdefined( level.objectivetext ) )
        level.objectivetext = 7500;

    scripts\engine\utility::flag_init( "endwave_audiocountdown_running" );
    var_0 = getentarray( "target_brushmodel", "script_noteworthy" );

    foreach ( var_2 in var_0 )
    {
        var_2.targetname = "null";
        var_2.target = "null";
    }

    while ( !isdefined( level.struct_class_names ) )
        waitframe();

    dialog_init();
    progression();
}

progression()
{
    level.course_triggers = getentarray( "progression", "targetname" );
    level.course_targets = gettargetarray();
    level.movers = scripts\engine\utility::getstructarray( "mover_start", "script_noteworthy" );
    _debug_rooftop_raid_exfil::waittill_player_isdefined();

    foreach ( var_1 in level.course_targets )
    {
        var_1.activated = 0;
        var_1 thread target_think();
    }

    level._id_128AF = getentarray( "trial_flare", "targetname" );

    if ( isdefined( level._id_128AF ) )
        scripts\engine\utility::array_thread( level._id_128AF, ::_id_128E8 );

    level._id_128E6[1] = getentarray( "wave1", "targetname" );
    level._id_128E6[2] = getentarray( "wave2", "targetname" );
    level._id_128E6[3] = getentarray( "wave3", "targetname" );
    level._id_128E6[4] = getentarray( "wave4", "targetname" );
    level.player thread infinite_reserve_ammo_not_revolver();
    level.player scripts\mp\utility\perk::giveperk( "specialty_quickswap" );
    level.player scripts\mp\utility\perk::giveperk( "specialty_fastreload" );
    hud_init();

    for (;;)
    {
        trial_score_init();
        score_event_time_remaining( 25000, 25000, 25000, 25000 );
        level.target_wave = 0;
        _debug_rooftop_raid_exfil::trial_ui_set_wave( 1, 4 );
        course_start_wait();
        _debug_rooftop_raid_exfil::_id_128F2();
        _debug_rooftop_raid_exfil::_id_128F3( 0 );
        wave_single_progression( level._id_128E6[1], 1 );
        wave_single_progression( level._id_128E6[2], 2 );
        wave_single_progression( level._id_128E6[3], 3 );
        wave_single_progression( level._id_128E6[4], 4 );
        score_calculate( 1 );
        _debug_rooftop_raid_exfil::_id_128F3( 1 );

        foreach ( var_7 in level.player.primaryinventory )
            level.player setweaponammoclip( var_7, weaponclipsize( var_7 ) );

        _debug_rooftop_raid_exfil::trial_ui_waittill_retry();
        level notify( "trial_retry" );
    }
}

course_start_wait()
{
    if ( istrue( level.trial_first_start ) )
        return;

    var_0 = getent( "outline", "script_noteworthy" );

    while ( !isdefined( var_0.spawned_weapon ) )
        waitframe();

    while ( isdefined( var_0.spawned_weapon ) )
        waitframe();

    level notify( "trial_start" );
    level.trial_first_start = 1;
    level.player scripts\mp\utility\dialog::leaderdialogonplayer( "kh_sniper_start" );
    wait 1;
}

wave_single_progression( var_0, var_1 )
{
    hud_inter_round_flow( var_1 );
    level notify( "new_wave" );
    level.target_wave = var_1;
    _debug_rooftop_raid_exfil::trial_ui_set_wave( level.target_wave, 4 );
    var_2 = gettime();
    _debug_rooftop_raid_exfil::trial_ui_set_secondary_timer( var_2 + 25000 );
    var_3 = 1;

    foreach ( var_5 in var_0 )
        var_5 thread target_flip( "up" );

    var_7 = 0;

    for (;;)
    {
        var_8 = 1;

        foreach ( var_5 in var_0 )
        {
            if ( !var_5.activated && !isdefined( var_5.is_civilian ) )
                var_8 = 0;
        }

        if ( var_8 )
            break;

        if ( gettime() > var_2 + 25000 - level.objectivetext && istrue( level._id_128F9 ) && !var_7 )
        {
            var_7 = 1;
            thread parachute_set_spawn_values( var_0, 1 );
        }

        if ( gettime() > var_2 + 25000 )
            break;

        if ( !scripts\engine\utility::flag( "endwave_audiocountdown_running" ) && gettime() > var_2 + 25000 - 5000 )
        {
            scripts\engine\utility::flag_set( "endwave_audiocountdown_running" );
            thread trial_failure_countdown();
        }

        waitframe();
    }

    if ( istrue( level._id_128F9 ) )
        thread parachute_set_spawn_values( var_0, 0 );

    level notify( "wave_ended", var_1 );
    scripts\engine\utility::flag_clear( "endwave_audiocountdown_running" );
    var_11 = clamp( var_2 + 25000 - gettime(), 0, 25000 );

    foreach ( var_5 in var_0 )
        var_5 thread target_flip( "down" );

    switch ( var_1 )
    {
        case 1:
            score_event_time_remaining( var_11, undefined, undefined, undefined );
            break;
        case 2:
            score_event_time_remaining( undefined, var_11, undefined, undefined );
            break;
        case 3:
            score_event_time_remaining( undefined, undefined, var_11, undefined );
            break;
        case 4:
            score_event_time_remaining( undefined, undefined, undefined, var_11 );
            break;
        default:
            break;
    }
}

parachute_set_spawn_values( var_0, var_1 )
{
    foreach ( var_3 in var_0 )
    {
        if ( var_1 )
        {
            if ( !var_3.activated && !isdefined( var_3.is_civilian ) )
            {
                var_3.headicon = deleteheadicon( var_3 );
                setheadiconfriendlyimage( var_3.headicon, "icon_navbar_enemy" );
                setheadiconsnaptoedges( var_3.headicon, 30000 );
                addclienttoheadiconmask( var_3.headicon, 75 );
            }

            continue;
        }

        if ( !var_3.activated )
        {
            if ( isdefined( var_3.headicon ) )
            {
                setheadiconimage( var_3.headicon );
                var_3.headicon = undefined;
            }
        }
    }
}

trial_failure_countdown()
{
    for ( var_0 = 5; var_0 > 0; var_0-- )
    {
        level endon( "wave_ended" );
        level.player playsound( "trial_sfx_failure_countdown" );
        wait 1;
    }

    scripts\engine\utility::flag_clear( "endwave_audiocountdown_running" );
}

target_think()
{
    self.initial_up = anglestoup( self.angles );
    self.parts = getentarray( self.script_linkname, "script_linkto" );
    self.parts = scripts\engine\utility::array_remove( self.parts, self );

    foreach ( var_1 in self.parts )
    {
        switch ( var_1.script_noteworthy )
        {
            case "target_plate":
                self.plate = var_1;

                if ( isdefined( self.plate.target ) )
                    self.plate.obit_destroy_old_vehicles = 1;

                break;
            case "target_arm":
                self.arm = var_1;
                break;
            case "target_base":
                self.base = var_1;
                break;
            case "target_wheels":
                self.wheels = var_1;
                break;
            case "target_glint":
                self.monitorhvt_gooddroppos = var_1;
                break;
            case "target_smoke":
                self.smoke = var_1;
                break;
            default:
                break;
        }

        var_1.target = "null";
        var_1.targetname = "null";
    }

    self.plate linkto( self );
    self.arm linkto( self );

    if ( isdefined( self.monitorhvt_gooddroppos ) )
        self.monitorhvt_gooddroppos linkto( self );

    if ( istrue( self.plate.obit_destroy_old_vehicles ) )
        self.plate thermaldrawdisable();

    if ( isdefined( self.wheels ) )
        self.wheels linkto( self.base );

    if ( isdefined( self.smoke ) )
        self.smoke linkto( self );

    self.state_up = 0;
    self.flipping = 0;
    thread target_damage();
    self.activated = 0;

    if ( issubstr( self.script_noteworthy, "moving" ) )
        thread moving_target_think();

    if ( issubstr( self.script_noteworthy, "civilian" ) )
        self.is_civilian = 1;
}

gettargetarray()
{
    var_0 = [ "standard_target", "moving_target", "civilian_target" ];
    var_1 = [];

    for ( var_2 = 0; var_2 < var_0.size; var_2++ )
    {
        var_3[var_2] = scripts\engine\utility::getstructarray( var_0[var_2], "script_noteworthy" );

        if ( var_0[var_2] == "civilian_target" )
        {
            if ( level.trial["variant"] == "pistol" )
                continue;

            if ( var_3[var_2].size > 0 )
                level.objectiveachievementkillcount = 1;
        }

        foreach ( var_5 in var_3[var_2] )
        {
            var_6 = spawn( "script_origin", var_5.origin );
            var_6.angles = var_5.angles;
            var_6.script_gameobjectname = var_5.script_gameobjectname;
            var_6.script_linkname = var_5.script_linkname;
            var_6.script_noteworthy = var_5.script_noteworthy;
            var_6.target = var_5.target;
            var_6.targetname = var_5.targetname;
        }
    }

    for ( var_2 = 0; var_2 < var_0.size; var_2++ )
        var_1[var_2] = getentarray( var_0[var_2], "script_noteworthy" );

    return scripts\engine\utility::array_combine_multiple( var_1 );
}

target_damage()
{
    for (;;)
    {
        self.activated = 0;
        self.plate waittill( "damage", var_0, var_1, var_2, var_3, var_4, var_5, var_6, var_7, var_8, var_9 );
        self.plate playsound( "trial_sfx_target_report_metal" );

        if ( isdefined( self.smoke ) )
            magicgrenademanual( "smoke_grenade_mp", self.smoke.origin, ( 0, 0, -1 ), 0.05 );

        if ( !isdefined( level.targethitsinaframecount ) )
            level.targethitsinaframecount = 0;

        level.targethitsinaframecount++;
        level.lasttargethitinaframe = self;
        level.shotsmissedcount = 0;
        level.player thread _debug_rooftop_raid_exfil::_id_128B5( self.plate, 1, 0, 0 );
        level.last_hit_target = self;
        thread target_flip( "down" );
        self.activated = 1;

        if ( isdefined( self.headicon ) )
        {
            setheadiconimage( self.headicon );
            self.headicon = undefined;
        }

        waittillframeend;

        if ( level.targethitsinaframecount > 1 && level.lasttargethitinaframe == self )
            thread score_event_collateral( level.targethitsinaframecount );

        if ( istrue( self.is_civilian ) )
        {
            level.score["civilian_killed"] = level.score["civilian_killed"] + 100;
            _debug_rooftop_raid_exfil::trial_ui_set_stat_and_bonus_score( 5, "civilian_targets_hit", level.score["civilian_killed"] / 100, level.score["civilian_killed"] * -1 );
            level.player thread scripts\mp\rank::scoreeventpopup( "trial_civilian_killed" );
            level.player playsound( "trial_sfx_buzzer_bad_1" );
            waitframe();
            score_calculate();
        }
        else if ( istrue( self.wave_enemies_remaining ) )
            thread score_event_target_hit( 200 );
        else
            thread score_event_target_hit( 100 );

        level.targethitsinaframecount = 0;
        level waittill( "course_ended" );
    }
}

target_flip( var_0 )
{
    if ( var_0 == "up" )
    {
        if ( isdefined( self.script_delay ) )
            wait( self.script_delay );

        self.plate setcandamage( 1 );

        if ( isdefined( self.monitorhvt_gooddroppos ) )
            self.monitorimpact = playfxontag( scripts\engine\utility::getfx( "ambush_sniper_glint" ), self.monitorhvt_gooddroppos, "tag_origin" );

        if ( self.state_up )
            return;

        self.state_up = 1;
        var_1 = 1;
        self.activated = 0;
    }
    else
    {
        self.plate setcandamage( 0 );

        if ( isdefined( self.monitorhvt_gooddroppos ) )
            killfxontag( scripts\engine\utility::getfx( "ambush_sniper_glint" ), self.monitorhvt_gooddroppos, "tag_origin" );

        if ( !self.state_up )
            return;

        self.state_up = 0;
        var_1 = -1;
    }

    var_2 = undefined;
    var_3 = undefined;

    switch ( self.script_noteworthy )
    {
        case "civilian_target":
        case "moving_target":
        case "standard_target":
            var_3 = 90;
            var_2 = 0.1;
            break;
        default:
            break;
    }

    self.flipping = 1;

    if ( issubstr( self.script_noteworthy, "moving" ) )
        waitframe();

    if ( var_0 == "up" )
        self playsoundonmovingent( "trial_sfx_target_flipup" );

    if ( self.initial_up[1] != 0 )
        self rotateyaw( -1 * self.initial_up[1] * var_3 * var_1, var_2 );
    else
        self rotatepitch( self.initial_up[2] * var_3 * var_1, var_2 );

    wait( var_2 );
    self.flipping = 0;
}

moving_target_think()
{
    self.mover = scripts\engine\utility::getclosest( self.origin, level.movers, 32 );

    if ( !isdefined( self.mover ) )
        return;

    self.mover_ends = scripts\engine\utility::getstructarray( self.mover.targetname, "target" );

    if ( self.mover_ends.size > 2 )
        self.wave_enemies_remaining = 1;

    self.mover_ends = sortbydistance( self.mover_ends, self.mover.origin );
    self.moveforward = 1;
    self.moving = 0;

    if ( isdefined( self.script_speed ) )
        self.move_speed = self.script_speed;
    else
        self.move_speed = 32;

    while ( !isalive( level.player ) )
        waitframe();

    thread moving_target_reset();

    for (;;)
    {
        if ( self.moving && ( 90 > distance( level.players[0].origin, self.origin ) || !self.state_up ) )
        {
            self notify( "stop_moving" );
            self.moving = 0;
            self.dummy delete();
        }
        else if ( !self.flipping && !self.moving && 90 < distance( level.players[0].origin, self.origin ) && self.state_up )
            thread moving_target_mover();

        waitframe();
    }
}

moving_target_mover()
{
    self endon( "stop_moving" );
    self.moving = 1;
    self.dummy = spawn( "script_origin", self.origin );
    childthread target_follow_dummy();

    for (;;)
    {
        if ( istrue( self.wave_enemies_remaining ) )
            var_0 = scripts\engine\utility::random( self.mover_ends );
        else
            var_0 = self.mover_ends[self.moveforward];

        var_1 = distance( self.dummy.origin, var_0.origin );
        var_2 = var_1 / self.move_speed;
        var_2 = clamp( var_2, 0.05, 9999 );
        var_3 = 0.5;
        var_3 = clamp( var_3, 0, var_2 / 2 );
        self.dummy moveto( var_0.origin, var_2, var_3, var_3 );
        wait( var_2 );
        self.moveforward = !self.moveforward;
    }
}

moving_target_reset()
{
    for (;;)
    {
        level waittill( "trial_results_screen_opened" );
        waitframe();
        self.origin = self.mover.origin;
        self.base.origin = self.mover.origin;
        self.moveforward = 1;
    }
}

target_follow_dummy()
{
    for (;;)
    {
        self.origin = self.dummy.origin;
        self.base.origin = self.dummy.origin;
        waitframe();
    }
}

trial_score_init()
{
    if ( !isdefined( level.score_initialized_once ) )
    {
        level.score = [];
        level.score["best"] = 0;
        game["trial"]["analytics"]["wave1time"] = 0;
        game["trial"]["analytics"]["wave2time"] = 0;
        game["trial"]["analytics"]["wave3time"] = 0;
        game["trial"]["analytics"]["wave4time"] = 0;
        _debug_rooftop_raid_exfil::trial_ui_set_best_score( level.score["best"] );
        level.score_initialized_once = 1;
    }

    level.score["total"] = 0;
    level.score["subtotal"] = 0;
    level.score["target_hit"] = 0;
    level.score["time_remaining_w1"] = 0;
    level.score["time_remaining_w2"] = 0;
    level.score["time_remaining_w3"] = 0;
    level.score["time_remaining_w4"] = 0;
    level.score["collateral"] = 0;
    level.score["civilian_killed"] = 0;

    if ( istrue( level.objectiveachievementkillcount ) )
        _debug_rooftop_raid_exfil::trial_ui_set_stat_and_bonus_score( 5, "civilian_targets_hit", level.score["civilian_killed"], level.score["civilian_killed"] );

    score_calculate();
}

score_event_target_hit( var_0 )
{
    level.score["target_hit"] = level.score["target_hit"] + var_0;
    level.player thread scripts\mp\rank::scorepointspopup( var_0 );
    waitframe();
    score_calculate();
}

score_event_collateral( var_0 )
{
    var_1 = 50 * ( var_0 - 1 );
    level.score["collateral"] = level.score["collateral"] + var_1;

    switch ( var_0 )
    {
        case 3:
            var_2 = "trial_collateral_triple";
            break;
        case 4:
            var_2 = "trial_collateral_quad";
            break;
        default:
            var_2 = "trial_collateral";
            break;
    }

    level.player thread scripts\mp\rank::scoreeventpopup( var_2 );
    level.player thread scripts\mp\rank::scorepointspopup( var_1 );
    level notify( "trial_sniper_collateral" );
}

score_event_time_remaining( var_0, var_1, var_2, var_3 )
{
    if ( isdefined( var_0 ) )
    {
        level.score["time_remaining_w1"] = scripts\mp\utility\script::limitdecimalplaces( var_0 / 1000, 1 ) * 10;
        _debug_rooftop_raid_exfil::trial_ui_set_stat_and_bonus_score( 1, "wave_1_time_remaining", var_0, level.score["time_remaining_w1"] );
    }

    if ( isdefined( var_1 ) )
    {
        level.score["time_remaining_w2"] = scripts\mp\utility\script::limitdecimalplaces( var_1 / 1000, 1 ) * 10;
        _debug_rooftop_raid_exfil::trial_ui_set_stat_and_bonus_score( 2, "wave_2_time_remaining", var_1, level.score["time_remaining_w2"] );
    }

    if ( isdefined( var_2 ) )
    {
        level.score["time_remaining_w3"] = scripts\mp\utility\script::limitdecimalplaces( var_2 / 1000, 1 ) * 10;
        _debug_rooftop_raid_exfil::trial_ui_set_stat_and_bonus_score( 3, "wave_3_time_remaining", var_2, level.score["time_remaining_w3"] );
    }

    if ( isdefined( var_3 ) )
    {
        level.score["time_remaining_w4"] = scripts\mp\utility\script::limitdecimalplaces( var_3 / 1000, 1 ) * 10;
        _debug_rooftop_raid_exfil::trial_ui_set_stat_and_bonus_score( 4, "wave_4_time_remaining", var_3, level.score["time_remaining_w4"] );
    }
}

score_calculate( var_0 )
{
    if ( !isdefined( var_0 ) )
        var_0 = 0;

    level.score["subtotal"] = level.score["target_hit"] + level.score["collateral"];
    level.score["total"] = level.score["subtotal"] + level.score["time_remaining_w1"] + level.score["time_remaining_w2"] + level.score["time_remaining_w3"] + level.score["time_remaining_w4"] - level.score["civilian_killed"];
    _debug_rooftop_raid_exfil::trial_ui_set_subscore( level.score["subtotal"] );
    hud_set_reward_tier();

    if ( var_0 )
    {
        _debug_rooftop_raid_exfil::trial_ui_set_secondary_timer( -1 );
        wait 1;

        if ( level.score["total"] < 0 )
            level.score["total"] = 0;

        _debug_rooftop_raid_exfil::trial_ui_set_main_score( level.score["total"] );

        if ( level.score["best"] < level.score["total"] )
        {
            level.score["best"] = level.score["total"];
            _debug_rooftop_raid_exfil::trial_ui_set_best_score( level.score["best"] );
            game["trial"]["analytics"]["wave1time"] = level.score["time_remaining_w1"];
            game["trial"]["analytics"]["wave2time"] = level.score["time_remaining_w2"];
            game["trial"]["analytics"]["wave3time"] = level.score["time_remaining_w3"];
            game["trial"]["analytics"]["wave4time"] = level.score["time_remaining_w4"];
        }

        hud_set_reward_tier( 1 );
        level notify( "course_ended" );

        if ( _debug_rooftop_raid_exfil::_id_128B6() )
            wait 4;

        thread _debug_rooftop_raid_exfil::trial_ui_open_results_screen();
    }
}

hud_init()
{
    level.target_wave = 0;
    level.wave_time = 30;
    level.timer_paused = 0;
    _debug_rooftop_raid_exfil::trial_ui_set_subscore( 0 );
    _debug_rooftop_raid_exfil::trial_ui_set_wave( 1, 4 );
    _debug_rooftop_raid_exfil::trial_ui_set_reward_tier_preview( 0 );
    _debug_rooftop_raid_exfil::trial_ui_set_objective_icon_index( 1 );
}

hud_set_reward_tier( var_0 )
{
    if ( !isdefined( var_0 ) )
        var_0 = 0;

    if ( var_0 )
        var_1 = level.score["best"];
    else
        var_1 = level.score["subtotal"];

    if ( var_1 >= level.trial["tier3"] )
        var_2 = 3;
    else if ( var_1 >= level.trial["tier2"] )
    {
        var_3 = level.trial["tier3"] - level.trial["tier2"];
        var_4 = var_1 - level.trial["tier2"];
        var_2 = 2 + var_4 / var_3;
    }
    else if ( var_1 >= level.trial["tier1"] )
    {
        var_3 = level.trial["tier2"] - level.trial["tier1"];
        var_4 = var_1 - level.trial["tier1"];
        var_2 = 1 + var_4 / var_3;
    }
    else
        var_2 = var_1 / level.trial["tier1"];

    if ( var_0 )
    {
        _debug_rooftop_raid_exfil::trial_ui_set_reward_tier( var_2 );

        if ( var_1 >= level.trial["tier3"] )
        {
            var_5 = game["music"]["trials_win_high"].size;
            var_6 = randomint( var_5 );
            level.player setplayermusicstate( game["music"]["trials_win_high"][var_6] );
            return;
        }

        if ( var_1 >= level.trial["tier2"] )
        {
            var_5 = game["music"]["trials_win_mid"].size;
            var_6 = randomint( var_5 );
            level.player setplayermusicstate( game["music"]["trials_win_mid"][var_6] );
            return;
        }

        if ( var_1 >= level.trial["tier1"] )
        {
            var_5 = game["music"]["trials_win_low"].size;
            var_6 = randomint( var_5 );
            level.player setplayermusicstate( game["music"]["trials_win_low"][var_6] );
            return;
        }

        var_5 = game["music"]["trials_loss"].size;
        var_6 = randomint( var_5 );
        level.player setplayermusicstate( game["music"]["trials_loss"][var_6] );
        return;
        return;
        return;
    }
    else
        _debug_rooftop_raid_exfil::trial_ui_set_reward_tier_preview( var_2 );
}

hud_inter_round_flow( var_0 )
{
    _debug_rooftop_raid_exfil::trial_ui_freeze_secondary_timer( 1 );
    setomnvar( "ui_match_start_text", "wave_" + var_0 + "_start" );
    level.player playsound( "trial_sfx_success" );

    if ( istrue( level._id_128FE ) && isdefined( level._id_128FF ) && level._id_128FF == var_0 )
    {
        var_1 = scripts\engine\utility::getstruct( "trial_wp", "targetname" );
        thread _id_128D5( var_1 );
        scripts\mp\gamelogic::teamstarttimer( level.player.team, 10 );
    }
    else
        scripts\mp\gamelogic::teamstarttimer( level.player.team, 5 );

    level.player setclientomnvar( "ui_match_start_countdown", -1 );
    setomnvar( "ui_match_start_text", "none" );
    level.player playsound( "trial_sfx_start" );
    level.target_wave = var_0;
    _debug_rooftop_raid_exfil::trial_ui_set_wave( level.target_wave, 4 );
    _debug_rooftop_raid_exfil::trial_ui_freeze_secondary_timer( 0 );
    level.player scripts\mp\utility\dialog::leaderdialogonplayer( "kh_sniper_search" );
}

dialog_init()
{
    game["dialog"]["trial_intro"] = "kh_sniper_intro";
    game["dialog"]["trial_intro_short"] = "kh_sniper_intro_short";
    game["dialog"]["trial_end_tier_0"] = "kh_sniper_star0";
    game["dialog"]["trial_end_tier_1"] = "kh_sniper_star1";
    game["dialog"]["trial_end_tier_2"] = "kh_sniper_star2";
    game["dialog"]["trial_end_tier_3"] = "kh_sniper_star3";
    game["dialog"]["trial_retry"] = "kh_sniper_retry";
    game["dialog"]["sniper_start"] = "kh_sniper_start";
    game["dialog"]["sniper_search"] = "kh_sniper_search";
    game["dialog"]["sniper_nice_shot"] = "kh_sniper_goodshot";
    game["dialog"]["sniper_hurry_up"] = "kh_sniper_hurryup";
    game["dialog"]["sniper_try_again"] = "kh_sniper_retry";
    game["dialog"]["sniper_nag_bulletdrop"] = "kh_sniper_nag_bulletdrop";
    game["dialog"]["sniper_nag_mount"] = "kh_sniper_nag_mount";
    thread dialog_collateral_watcher();
    thread dialog_missed_shots_watcher();
    thread getquestrewardbuildgroupref();
}

dialog_collateral_watcher()
{
    for (;;)
    {
        level waittill( "trial_sniper_collateral" );
        level.player scripts\engine\utility::delaythread( 0.25, scripts\mp\utility\dialog::leaderdialogonplayer, "sniper_nice_shot" );
        wait 5;
    }
}

dialog_missed_shots_watcher()
{
    var_0 = 1;
    var_1 = 1;

    for (;;)
    {
        level waittill( "new_wave" );
        level.shotsmissedcount = 0;

        for (;;)
        {
            level.player waittill( "weapon_fired", var_2, var_3, var_4 );
            var_5 = anglestoforward( var_4 );
            level.shotsmissedcount++;
            waitframe();

            if ( level.shotsmissedcount > 2 )
            {
                if ( var_0 )
                {
                    var_6 = undefined;
                    var_7 = undefined;
                    var_8 = undefined;
                    var_9 = 360;

                    foreach ( var_11 in level._id_128E6[level.target_wave] )
                    {
                        var_12 = var_11.origin + ( 0, 0, 42 );
                        var_13 = distance( var_3, var_12 );
                        var_14 = var_5 * var_13;
                        var_15 = vectortoangles( var_12 - var_3 );
                        var_16 = anglesdelta( var_4, var_15 );

                        if ( var_16 < var_9 )
                        {
                            var_9 = var_16;
                            var_6 = var_11;
                            var_7 = var_12;
                            var_8 = var_13;
                        }
                    }

                    if ( distance( var_3, var_6.origin ) >= 4000 )
                    {
                        var_18 = distance( var_3 + var_5 * var_8, var_7 );

                        if ( var_18 <= 64 )
                        {
                            level.player scripts\mp\utility\dialog::leaderdialogonplayer( "sniper_nag_bulletdrop" );
                            var_0 = 0;
                            break;
                        }
                    }
                }

                if ( var_1 && level._id_128BC )
                {
                    level.player scripts\mp\utility\dialog::leaderdialogonplayer( "sniper_nag_mount" );
                    var_1 = 0;
                }
                else
                    level.player scripts\mp\utility\dialog::leaderdialogonplayer( "sniper_hurry_up" );

                break;
            }
        }
    }
}

getquestrewardbuildgroupref()
{
    level._id_128BC = 1;
    level waittill( "new_wave" );

    while ( level.player playermount() <= 0.5 )
        waitframe();

    level._id_128BC = 0;
}

infinite_reserve_ammo_not_revolver()
{
    level endon( "game_ended" );
    self endon( "disconnect" );
    var_0 = getent( "trial_starting_weapon", "script_noteworthy" );
    var_1 = strtok( var_0.script_parameters, "+" )[0];

    while ( !isdefined( self.currentprimaryweapon ) )
        waitframe();

    for (;;)
    {
        var_2 = self.currentprimaryweapon;

        if ( issubstr( var_2.basename, var_1 ) )
            self setweaponammostock( var_2, 0 );
        else
            self givemaxammo( var_2 );

        waitframe();
    }
}

_id_128D5( var_0 )
{
    level.player thread scripts\mp\utility\dialog::leaderdialogonplayer( level.player.team + "_enemy_white_phosphorus_inbound" );
    var_1 = [];
    var_1[0] = spawnstruct();
    var_1[0].angles = var_0.angles[1];
    var_1[0].location = var_0.origin;
    var_1[0].string = "confirm_location";
    var_2 = level.player scripts\cp_mp\utility\killstreak_utility::createstreakinfo( "white_phosphorus", level.player );
    var_2.mpstreaksysteminfo = scripts\mp\killstreaks\killstreaks::createstreakitemstruct( var_2.streakname );
    var_2.mpstreaksysteminfo.all_end_checkpoints_activated = gettime();
    level.wpinprogress = 1;

    foreach ( var_8, var_4 in var_1 )
    {
        var_5 = var_4.location;
        var_6 = var_4.angles;
        level.player thread scripts\cp_mp\killstreaks\white_phosphorus::_id_13033( "disconnect" );
        level.player thread scripts\cp_mp\killstreaks\white_phosphorus::_id_13033( "joined_team" );
        level.player thread scripts\cp_mp\killstreaks\white_phosphorus::_id_13033( "joined_spectator" );
        var_7 = level.player scripts\cp_mp\killstreaks\white_phosphorus::wp_createplane( var_5, var_6, var_2 );

        if ( !isdefined( var_7 ) )
            return 0;

        objective_delete( var_7.minimapid );
        var_7 thread scripts\cp_mp\killstreaks\white_phosphorus::_id_13037();
        var_7 thread scripts\cp_mp\killstreaks\white_phosphorus::wp_deliverpayloads( var_2 );

        if ( var_1.size > 1 && var_8 < var_1.size - 1 )
            wait( randomfloatrange( 1, 3.0 ) );
    }
}

_id_128E8()
{
    for (;;)
    {
        level waittill( "trial_start" );
        wait 3;

        if ( isdefined( self.script_noteworthy ) )
            wait( float( self.script_noteworthy ) );

        playfxontag( scripts\engine\utility::getfx( "trial_flare" ), self, "j_top" );
        self playsound( "gos_firework_scream_sfx" );

        if ( isdefined( self.script_noteworthy ) )
            var_0 = 3 - float( self.script_noteworthy );
        else
            var_0 = 3;

        if ( var_0 > 0 )
            wait( var_0 );

        stopfxontag( scripts\engine\utility::getfx( "trial_flare" ), self, "j_top" );
        playfxontag( scripts\engine\utility::getfx( "trial_thermite" ), self, "j_top" );
        self playsound( "gos_firework_explo_sfx" );
        wait 2.25;
        playfxontag( scripts\engine\utility::getfx( "trial_thermite_end" ), self, "j_top" );
        stopfxontag( scripts\engine\utility::getfx( "trial_thermite" ), self, "j_top" );
    }
}

blockreviveanimation()
{
    level._id_1289C = ::_id_128A3;

    if ( !isdefined( game["trial"]["analytics"] ) )
    {
        game["trial"]["analytics"] = [];
        game["trial"]["analytics"]["wave1time"] = 0;
        game["trial"]["analytics"]["wave2time"] = 0;
        game["trial"]["analytics"]["wave3time"] = 0;
        game["trial"]["analytics"]["wave4time"] = 0;
    }
}

_id_128A3()
{
    var_0 = level.trial["missionID"];
    var_1 = getomnvar( "ui_trial_reward_tier" );
    var_2 = getomnvar( "ui_trial_best_score" );
    var_3 = int( game["trial"]["analytics"]["wave1time"] );
    var_4 = int( game["trial"]["analytics"]["wave2time"] );
    var_5 = int( game["trial"]["analytics"]["wave3time"] );
    var_6 = int( game["trial"]["analytics"]["wave4time"] );
    level.player dlog_recordplayerevent( "dlog_event_trial_complete_sniper", [ "id", var_0, "tier", var_1, "score", var_2, "wave1time", var_3, "wave2time", var_4, "wave3time", var_5, "wave4time", var_6 ] );
}
